import os
import json
import pytz
import requests
import time
from datetime import datetime, timedelta
from typing import Optional, Dict, Any, List


class NVD_CVE_Parser:
    def __init__(self, api_url: str, api_key: str):
        self.api_url = api_url
        self.headers = {"apiKey": api_key}
        self.seoul_tz = pytz.timezone("Asia/Seoul")

    def _get_response(self, url: str, retry_count: int = 3) -> Optional[Dict[str, Any]]:
        if retry_count < 1:
            print("요청 재시도 횟수를 초과했습니다.")
            return None

        response = requests.get(url, headers=self.headers)

        if response.status_code == 403:
            print("API 요청이 너무 빠릅니다. 잠시 후 다시 시도합니다.")
            time.sleep(6)
            return self._get_response(url, retry_count - 1)  # 6초 후에 재시도

        elif response.status_code != 200:
            print(f"API 요청에 실패했습니다. 상태 코드: {response.status_code}")
            print(response.text)
            return None

        try:
            return response.json()
        except json.JSONDecodeError:
            print("API에서 반환한 응답이 JSON 형식이 아닙니다. 응답 내용:")
            print(response.text)
            return None

    def fetch_cve_data(self, start_index: int, results_per_page: int) -> Optional[List[Dict[str, Any]]]:
        url = f"{self.api_url}/?resultsPerPage={results_per_page}&startIndex={start_index}"
        response_json = self._get_response(url)

        if response_json is None:
            return None

        cve_data = response_json["vulnerabilities"]

        self.save_cve_data(cve_data)
        
        return cve_data
    
    def fetch_modified_cve_data(self, days: int = 0) -> Optional[List[str]]:
        now = datetime.now(self.seoul_tz) - timedelta(days)

        start_of_yesterday = now.replace(hour=0, minute=0, second=0, microsecond=0)
        end_of_yesterday = start_of_yesterday + timedelta(days=1)

        start_date = start_of_yesterday.isoformat().replace("+", "%2B")
        end_date = end_of_yesterday.isoformat().replace("+", "%2B")

        url = f"{self.api_url}?lastModStartDate={start_date}&lastModEndDate={end_date}"

        response_json = self._get_response(url)

        if response_json is None:
            return None

        cve_ids = []

        cve_data = response_json["vulnerabilities"]
        self.save_cve_data(cve_data)

        for cve_item in cve_data:
            cve_id = cve_item["cve"]["id"]
            cve_ids.append(cve_id)
    
        return cve_ids
    
    def fetch_cve_data_with_keyword(
        self,
        start_index: int,
        results_per_page: int,
        keyword: str,
        exact_match: bool = False,
    ) -> Optional[List[str]]:
        if keyword == "":
            raise ValueError(
                "Warning: No keyword provided. Please specify a keyword and try again."
            )

        keyword_encoded = requests.utils.quote(keyword)
        url = f"{self.api_url}/?keywordSearch={keyword_encoded}&resultsPerPage={results_per_page}&startIndex={start_index}"

        if exact_match:
            url += "&keywordExactMatch"

        response_json = self._get_response(url)

        if response_json is None:
            return None

        cve_ids = []

        cve_data = response_json["vulnerabilities"]
        for cve_item in cve_data:
            cve_id = cve_item["cve"]["id"]
            cve_ids.append(cve_id)
     
        return cve_ids

    def is_fetch_completed(self, data: Optional[List[Dict[str, Any]]], expected_length: int) -> bool:
        if data is None or len(data) < expected_length:
            return True

        return False

    def _year_division(self, cve_id: str) -> str:
        return cve_id.split("-")[1]

    def _create_directory(self, year: str) -> None:
        if not os.path.exists(f"./jsons/{year}"):
            os.makedirs(f"./jsons/{year}")

    def save_cve_data(self, cve_data: list) -> None:
        for cve_item in cve_data:
            cve_id = cve_item["cve"]["id"]
            print(f"{cve_id} 정보 저장.....")

            year = self._year_division(cve_id)
            self._create_directory(year)
            
            self.save_json(cve_item, year)
            
    def save_json(self, cve_item: dict, year: str) -> None:
        cve_id = cve_item["cve"]["id"]

        file_path = f"./jsons/{year}"

        with open(f"{file_path}/{cve_id}.json", "w") as out_file:
            json.dump(cve_item, out_file, indent=4)


if __name__ == "__main__":
    NVD_API_URL = "https://services.nvd.nist.gov/rest/json/cves/2.0/"

    # API 키를 저장하고 있는 파일에서 API 키를 읽어옵니다.
    with open("api_key", "r") as file:
        API_KEY = file.read().strip()

    nvd = NVD_CVE_Parser(NVD_API_URL, API_KEY)

    start_index = 0
    results_per_page = 2000

    request_count = 0

    # Fetching all data
    # while True:
    #     cve_data = nvd.fetch_cve_data(start_index, results_per_page)

    #     if nvd.is_fetch_completed(cve_data, results_per_page):
    #         print("모든 정보를 가져왔습니다.")
    #         break

    #     start_index += results_per_page

    # Fetching modified data
    # print(nvd.fetch_modified_cve_data(days=1)
    
    # Fetching data with keyword
    keyword = "Microsoft Office"
    keyword_cve_lsit = []
    while True:
        cve_ids = nvd.fetch_cve_data_with_keyword(
            start_index,
            results_per_page,
            keyword,
            exact_match=True
        )
        if cve_ids is None or len(cve_ids) == 0:
            break
        keyword_cve_lsit.extend(cve_ids)
        start_index += results_per_page
    print(keyword_cve_lsit)
    