import os
import shutil
from git import Repo
from db_json_handler import Save_DB

unnecessary_files = ['README.md', '.git']

class PoC_Parser:
    def __init__(self, repo_url, repo_dir):
        self.repo_url = repo_url
        self.repo_dir = repo_dir
        
        # Create the repo_dir if it does not exist
        os.makedirs(self.repo_dir, exist_ok=True)
        
        self.db_handler = Save_DB(repo_dir)
    
    def _remove_unnecessary_files(self):
        for file in unnecessary_files:
            file_path = os.path.join(self.repo_dir, file)
            if os.path.isfile(file_path):
                os.remove(file_path)
            elif os.path.isdir(file_path):
                shutil.rmtree(file_path)
    
    def clone(self):
        # If the repo_dir exists, delete it
        if os.path.exists(self.repo_dir):
            shutil.rmtree(self.repo_dir)
            
        # Clone the repo
        Repo.clone_from(self.repo_url, self.repo_dir)
        
        self._remove_unnecessary_files()
        
    def save(self):
        self.db_handler.delete("PoC_INFO")
        self.db_handler.save("PoC_INFO")
        
                    
if __name__ == "__main__":
    repo_url = "https://github.com/nomi-sec/PoC-in-GitHub.git"
    repo_dir = "./poc"
    
    
    poc = PoC_Parser(repo_url, repo_dir)
    
    poc.clone()
    poc.save()
