import requests, json, time, os
from pymongo import MongoClient

class NVD_CVE_Parser:
    def __init__(self, api_url):
        self.api_url = api_url

    def fetch_cve_data(self, start_index: int, results_per_page: int):
        url = f"{self.api_url}/?resultsPerPage={results_per_page}&startIndex={start_index}"
        response = requests.get(url)

        if response.status_code == 200:
            cve_data = json.loads(response.text)["vulnerabilities"]
            self.save_cve_data(cve_data)

            if len(cve_data) < results_per_page:
                print("모든 정보를 불려왔습니다.")
                return True

        elif response.status_code == 403:
                print("API 요청이 너무 빠릅니다. 잠시 후 다시 시도합니다.")
                time.sleep(6)

        else:
            print(f"API 요청에 실패했습니다. 상태 코드: {response.status_code}")
            return False
            

    def save_cve_data(self, cve_data: list):
        for cve_item in cve_data:
            cve_id = cve_item["cve"]["id"]
            print(f'{cve_id} 정보 저장.....')

            year = self.__year_division(cve_id)
            self.__create_directory(year)

            self.save_json(cve_item)

    def __year_division(self, cve_id: str):
        return cve_id.split('-')[1]

    def __create_directory(self, year: str):
        if not os.path.exists(f'./jsons/{year}'):
            os.makedirs(f"./jsons/{year}")

    def save_json(self, cve_item: dict):
        cve_id = cve_item["cve"]["id"]
        year = self.__year_division(cve_id)

        file_path = f'./jsons/{year}'

        with open(f'{file_path}/{cve_id}.json', 'w') as out_file:
            json.dump(cve_item, out_file, indent=4)

if __name__ == "__main__":
    NVD_API_URL = "https://services.nvd.nist.gov/rest/json/cves/2.0/"

    nvd = NVD_CVE_Parser(NVD_API_URL)

    start_index = 0
    results_per_page = 2000

    while True:
        if isinstance(nvd.fetch_cve_data(start_index, results_per_page), bool):
            break
            
        start_index += results_per_page
