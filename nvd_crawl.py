import sys
import argparse
from Crawling import NVD_CVE_Parser, Save_DB

NVD_API_URL = "https://services.nvd.nist.gov/rest/json/cves/2.0/"

# Read the API key from the file where it is stored.
with open("api_key", "r") as file:
    API_KEY = file.read().strip()

nvd = NVD_CVE_Parser(NVD_API_URL, API_KEY)

start_index = 0
results_per_page = 2000

save_db = Save_DB(json_path="./jsons")

# Use argparse for command-line argument parsing
parser = argparse.ArgumentParser(description="Fetch CVE data from NVD.")
group = parser.add_mutually_exclusive_group(required=True)
group.add_argument(
    "--all",
    action="store_true",
    help="The NVD API parses all CVE information and stores it in MongoDB. Note that if an existing collection is present in MongoDB, it will be deleted before saving.",
)
group.add_argument(
    "--update",
    action="store_true",
    help="The NVD API parses the updated CVE information from the current date and stores it in MongoDB.",
)

args = parser.parse_args()

if args.all:
    save_db.db["CVE_INFO"].drop()
    while True:
        data = nvd.fetch_cve_data(start_index, results_per_page)
        if nvd.is_fetch_completed(data, results_per_page): 
            break
        start_index += results_per_page
    save_db.save("CVE_INFO")
elif args.update:
    update_cve_list = nvd.fetch_modified_cve_data()
    save_db.update("CVE_INFO", update_cve_list)
