from flask import request, jsonify
from flask_restx import Namespace, Resource
import openai
import os

openai.api_key = os.getenv('CHATGPT_API')

def gpt(sqlite_client):
    api = Namespace('gpt', description='ChatGPT 관련 라우트')
    
    @api.route('/test')
    class TEST(Resource):
        @api.doc(
            responses={200: "Success"},
            description="ChatGPT에 'log4shell' 취약점에 대해 물어보고 응답 받기"
        )
        def get(self):
            text = "CVE-2021-44228에 대해서 설명해줘"

            response = openai.ChatCompletion.create(
                model="gpt-3.5-turbo-0613",
                messages=[
                    {"role": "system", "content": "You are a helpful assistant."},
                    {"role": "user", "content": text},
                ]
            )

            return {"response": response['choices'][0]['message']['content'].strip()}, 200

    @api.route('/cve/<cve_id>')
    class CVE(Resource):
        @api.doc(
            responses={200: "Success"},
            description="ChatGPT에 CVE 정보를 바탕으로 조치 방안 요청"
        )
        def get(self, cve_id): 
            cursor = sqlite_client.cursor()
            cursor.execute("""
                SELECT id, description, cvss
                FROM vulnerability_metadata
                WHERE id = ? and namespace = "nvd:cpe"
            """, (cve_id,))
            cve_info = cursor.fetchone()
            cursor.close()

            if not cve_info:
                return {"error": "CVE 정보를 찾을 수 없습니다."}, 404

            plan_content = f"""
                [CVE 정보] 
                {cve_info[0]}
                
                [취약점 설명]
                {cve_info[1]} 
                
                [CVSS정보]
                {cve_info[2]}
        
                위 취약점에 대한 조치방안을 다음과 같은 형식으로 요약해줘.
                이때 버전 업그레이드의 조치방안은 빼줘 그리고 조치방안은 5개 이하로 알려줘

                [조치 방안]
                1. ~~~~
                2. ~~~~
                3. ~~~~
                4. ~~~~
                5. ~~~~
            """

            plan_response = openai.ChatCompletion.create(
                model="gpt-3.5-turbo",
                messages=[
                    {"role": "system", "content": "You are an information security expert who speaks Korean."},
                    {"role": "user", "content": plan_content},
                ]
            )
            
            cve_info_content = f"""
                {cve_info[1]}

                취약점 설명에 대해서 한국어로 번역해줘.
                이때 전문용어는 번역하지 말고 그대로 사용해줘.
            """
            
            cve_info_response = openai.ChatCompletion.create(
                model="gpt-3.5-turbo",
                messages=[
                    {"role": "system", "content": "You are an information security expert who speaks Korean."},
                    {"role": "user", "content": cve_info_content},
                ]
            )
            
            return {
                "response": f"[CVE 정보]\n{cve_info[0]}\n\n[취약점 설명]\n{cve_info_response['choices'][0]['message']['content'].strip()}\n\n[CVSS 정보]\n{cve_info[2]}\n\n{plan_response['choices'][0]['message']['content'].strip()}"
            }, 200
        
    return api