from flask import request, jsonify
from flask_restx import Namespace, Resource

protected_dbs = ["admin", "config", "local"]

def db(mongo_client):
    api = Namespace("db", description="Database 관련 API")

    @api.route("/database-list")
    class DatabaseList(Resource):
        @api.doc(description="MongoDB의 모든 Database 리스트 출력")
        def get(self):
            db_list = mongo_client.list_database_names()
            return jsonify(db_list)
    

    @api.route("/collection-list/<string:db_name>")
    class CollectionList(Resource):
        @api.doc(
            params={"db_name": "Name of the database"},
            responses={
                200: "Success",
                403: "Access denied to the database",
                404: "Database does not exist",
            },
            description="db_name 파라미터로 전달한 Database의 모든 Collection 리스트 출력",
        )
        def get(self, db_name):
            if db_name in protected_dbs:
                return {"error": f"Access denied to {db_name} DB."}, 403

            if db_name in mongo_client.list_database_names():
                db = mongo_client[db_name]
                collection_list = db.list_collection_names()

                return collection_list, 200
            else:
                return {"error": f"{db_name} does not exist."}, 404

    return api