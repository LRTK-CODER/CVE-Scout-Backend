from flask import Flask, jsonify, request
from pymongo import MongoClient
import json

app = Flask(__name__)

mongo_client = MongoClient(host='localhost', port=27017)
protected_dbs = ['admin', 'config', 'local']

@app.route('/')
def test():
    return 'test'

@app.route('/api/dbs')
def db_list():
    db_list = mongo_client.list_database_names()
    return jsonify(db_list)

@app.before_request
def require_auth():
    if request.endpoint == 'collection_list':
        db_name = request.args.get('db')
        if db_name in protected_dbs:
            return jsonify({'error': f'Access denied to {db_name} DB.'}), 403

@app.route('/api/tables')
def collection_list():
    db_name = request.args.get('db')

    if db_name in mongo_client.list_database_names():
        db = mongo_client[db_name]
        collection_list = db.list_collection_names()
        return jsonify(collection_list)
    else:
        return jsonify({'error': f'{db_name} does not exist.'}), 404

@app.route('/api/cves')
def cve_list():
    cve_data = []
    for cve in mongo_client["cve_database"]["cves"].find({}, {"_id": 0, "cve.id": 1}):
        cve_data.append(cve["cve"]["id"])
    cve_count = len(cve_data)
    return jsonify({"count": cve_count, "cve": cve_data})

@app.route('/api/cves/<cve_id>')
def cve_info(cve_id):
    cve_data = mongo_client["cve_database"]["cves"].find_one({"cve.id": cve_id}, {"_id": 0})
    if cve_data:
        return jsonify(cve_data)
    else:
        return jsonify({'error': f'{cve_id} not found.'}), 404

@app.route('/api/cve/<int:year>')
def cve_list_by_year(year):
    cve_data = []
    cve_collection = mongo_client["cve_database"]["cves"]
    for cve in cve_collection.find({"cve.id": {"$regex": f"CVE-{year}-"}}, {"_id": 0, "cve.id": 1}):
        cve_data.append(cve["cve"]["id"])
    cve_count = len(cve_data)
    return jsonify({"count": cve_count, "cve": cve_data})


if __name__ == '__main__':
    app.run(host='0.0.0.0', debug=True)
